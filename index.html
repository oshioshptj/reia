<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã›ã©ã‚Šåˆ¤å®šï¼ˆæ¥½å¤©APIï¼‰</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  input, button { padding: 8px; font-size: 16px; width: 100%; margin-bottom: 10px; }
  .result { margin-top: 20px; padding: 15px; border-radius: 8px; }
  .good { background: #e0f7e9; }
  .maybe { background: #fff7d6; }
  .bad { background: #ffe0e0; }
</style>
</head>
<body>

<h2>æ¥½å¤©ã›ã©ã‚Šåˆ¤å®š</h2>

<input id="jan" placeholder="JANã‚³ãƒ¼ãƒ‰">
<input id="cost" type="number" placeholder="ä»•å…¥ã‚Œå€¤ï¼ˆå††ï¼‰">
<button onclick="check()">åˆ¤å®šã™ã‚‹</button>

<div id="result"></div>

<script>
const APP_ID = "1004732110586681240";

function check() {
  const input = document.getElementById("jan").value.trim();
  const cost = Number(document.getElementById("cost").value);
  const result = document.getElementById("result");

  result.innerHTML = "æ¤œç´¢ä¸­â€¦";

  const callbackName = "rakutenCallback_" + Date.now();

  window[callbackName] = function(data) {
    if (!data.Items || data.Items.length === 0) {
      result.innerHTML = "å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ¥½å¤©ã«JAN/å•†å“åæœªç™»éŒ²ï¼‰";
      return;
    }

    const item = data.Items[0].Item;
    const rakutenPrice = item.itemPrice;
    const sellPrice = Math.floor(rakutenPrice * 1.15);
    const profit = Math.floor(sellPrice * 0.9 - cost);

    let cls = "bad";
    let label = "âœ• ã‚¹ãƒ«ãƒ¼";
    if (profit >= 1000) { cls = "good"; label = "â— è²·ã„"; }
    else if (profit >= 300) { cls = "maybe"; label = "â–³ å¥½ããªã‚‰"; }

    result.className = `result ${cls}`;
    result.innerHTML = `
      <b>${item.itemName}</b><br><br>
      æ¥½å¤©æœ€å®‰ï¼šÂ¥${rakutenPrice}<br>
      æƒ³å®šå£²å€¤ï¼šÂ¥${sellPrice}<br>
      åˆ©ç›Šï¼šÂ¥${profit}<br><br>
      <b>${label}</b>
    `;

    delete window[callbackName];
  };

  // ğŸ”½ JANã‹å•†å“åã‹è‡ªå‹•åˆ¤å®š
  const isJan = /^\d{8,13}$/.test(input);

  let src =
    "https://app.rakuten.co.jp/services/api/IchibaItem/Search/20170706"
    + "?applicationId=" + APP_ID
    + "&hits=1"
    + "&sort=+itemPrice"
    + "&callback=" + callbackName;

  if (isJan) {
    src += "&jan=" + input;
  } else {
    src += "&keyword=" + encodeURIComponent(input);
  }

  const script = document.createElement("script");
  script.src = src;
  document.body.appendChild(script);
}
</script>
